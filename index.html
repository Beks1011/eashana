<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Расписание 1-11 классы</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(135deg,#a8e6cf,#56ab2f);overflow:hidden}
.header{display:flex;flex-direction:column;align-items:center;gap:6px;margin-top:10px;position:relative}
h1{font-size:3rem;color:#064420;padding:10px 30px;border-radius:20px;margin:0;background:rgba(255,255,255,0.9);box-shadow:0 4px 12px rgba(0,0,0,0.1)}
.school-name{font-size:1rem;color:#064420;padding:6px 20px;border-radius:12px;background:rgba(255,255,255,0.9);box-shadow:0 3px 10px rgba(0,0,0,0.1);text-align:center;max-width:95%;display:none;}
.arrow-menu{cursor:pointer;background:rgba(255,255,255,0.9);padding:6px 10px;border-radius:12px;box-shadow:2px 2px 6px rgba(0,0,0,.2);position:absolute;left:10px;top:50%;transform:translateY(-50%);z-index:1002}
.menu-items{position:absolute;top:60px;left:10px;background:rgba(255,255,255,0.95);padding:10px;border-radius:12px;box-shadow:2px 2px 10px rgba(0,0,0,.3);z-index:1000;display:none;width:260px}
.menu-items button{display:block;width:100%;margin-bottom:6px;padding:10px;border-radius:12px;border:none;background:#064420;color:#fff;font-weight:600;cursor:pointer;transition:all 0.2s}
.menu-items button:hover{background:#046936}
#authInfo{padding:6px 4px;border-radius:6px;margin-bottom:6px;color:#111;background:transparent}
.time-container{position:fixed;top:10px;right:10px;z-index:1000;background:rgba(255,255,255,0.9);padding:6px 12px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.2);text-align:center;font-weight:700}
#clock{font-size:1.2rem}
.schedule-wrapper{width:100%;overflow:hidden;margin-top:12px;height:calc(100vh - 180px);position:relative;display:none}
.schedule-container{display:flex;gap:16px;padding:12px;height:100%;transition:transform .8s ease-in-out;align-items:flex-start}
.schedule-card{background:rgba(255,255,255,0.95);padding:16px;border-radius:24px;box-shadow:0 8px 20px rgba(0,0,0,.15);width:45%;min-width:45%;flex-shrink:0;display:flex;flex-direction:column;overflow:hidden;transition:transform 0.2s}
.schedule-card:hover{transform:scale(1.02)}
.schedule-card h3{text-align:center;margin:0 0 8px 0;font-size:1.3rem;color:#064420;font-weight:700}
table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:0.9rem}
th,td{border:1px solid #ccc;text-align:center;vertical-align:middle;padding:6px;border-radius:8px}
th{background:#046936;color:#fff}
td select, td input{width:100%;padding:6px;font-size:0.85rem;border-radius:6px;border:1px solid #ccc;box-sizing:border-box}
.arrow-nav{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.9);padding:12px;border-radius:50%;cursor:pointer;box-shadow:2px 2px 6px rgba(0,0,0,.15);font-size:1.5rem;z-index:1001}
.arrow-left{left:8px}
.arrow-right{right:8px}
.popup{display:block;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.95);padding:20px;border-radius:20px;box-shadow:0 0 20px rgba(0,0,0,.3);z-index:1004;width:360px;max-width:92%}
.popup input, .popup button, .popup select, .popup textarea{margin:6px 0;padding:10px;border-radius:10px;border:1px solid #bdbdbd;box-sizing:border-box;width:100%;font-size:14px}
.btn{padding:10px 14px;border-radius:12px;border:none;background:#064420;color:#fff;cursor:pointer;font-weight:600;transition:all 0.2s}
.btn.gray{background:#046936;color:#fff}
.btn:hover{opacity:0.85}
.center{display:flex;justify-content:center;gap:8px;margin-top:8px}
.sep{height:8px;border:none}
</style>
</head>
<body>

<div class="header">
  <div class="arrow-menu" id="menuArrow" title="Меню">☰</div>
  <h1>Расписание 1-11 классы</h1>
  <div class="school-name" id="schoolName"></div>
  <div class="menu-items" id="menuItems">
    <div id="authInfo" style="display:none"></div>
    <button id="saveBtn" class="hidden-prelogin btn">Сохранить</button>
    <button id="resetBtn" class="hidden-prelogin btn gray">Очистить класс</button>
    <button id="autoScrollBtn" class="hidden-prelogin btn gray">Автопрокрутка</button>
    <button id="fullscreenBtn" class="hidden-prelogin btn gray">Расширить/Назад</button>
    <button id="addClassBtn" class="hidden-prelogin btn">Добавить класс</button>
    <button id="selectClassesBtn" class="hidden-prelogin btn gray">Выбрать классы</button>
    <hr class="sep">
    <button id="createAdminBtn" class="hidden-prelogin btn gray">Создать админ-акк</button>
    <button id="createSchoolBtn" class="hidden-prelogin btn gray">Создать акк школы</button>
    <button id="logoutBtn" class="hidden-prelogin btn gray">Выйти</button>
  </div>
</div>

<div class="time-container">
  <span id="clock">00:00:00</span><br><span id="dateText"></span>
</div>

<div class="schedule-wrapper" id="scheduleWrapper">
  <div class="arrow-nav arrow-left" id="prevBtn">◀</div>
  <div class="arrow-nav arrow-right" id="nextBtn">▶</div>
  <div class="schedule-container" id="scheduleContainer"></div>
</div>

<div class="popup" id="loginPopup">
  <h3>Вход</h3>
  <input id="loginUsername" placeholder="Имя админа или номер школы (например 33)">
  <input id="loginPassword" type="password" placeholder="Пароль">
  <div class="center">
    <button id="loginBtn" class="btn">Войти</button>
  </div>
</div>

<script>
const SUPABASE_URL = "https://xyklrjprajqhnyhphwfc.supabase.co";
const SUPABASE_ANON = "sb_publishable_466qL9obVEYISCMwlt-HSQ_jS-wttAT";
const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

const subjects = ["","Математика","Орыс тілі","Қазақ тілі","Физика","Химия","Биология","Тарих","География","Дене шынықтыру","Қолөнер","Музыка","Информатика","Ағылшын тілі","Қоғамтану"];
const letters = ["А","Б","В"];
let allClasses=[], scheduleData={}, pageIndex=0, autoScroll=true, currentUser=null;
let visibleClasses = []; // Для выбора видимых классов

for(let i=1;i<=11;i++){letters.forEach(l=>{const cls=`${i}${l}`; allClasses.push(cls); scheduleData[cls]={"Пн":[],"Вт":[],"Ср":[],"Чт":[],"Пт":[]}; for(const d in scheduleData[cls]) for(let k=0;k<8;k++) scheduleData[cls][d].push({subject:"",room:""});});}

function createCard(cls){
    const card=document.createElement('div');
    card.className='schedule-card';
    card.dataset.cls=cls;
    let html=`<h3>${cls}</h3><table><thead><tr><th>#</th><th>Пн</th><th>Вт</th><th>Ср</th><th>Чт</th><th>Пт</th></tr></thead><tbody>`;
    for(let r=0;r<8;r++){
        html+=`<tr><td>${r+1}</td>`;
        ["Пн","Вт","Ср","Чт","Пт"].forEach(()=>{html+=`<td><select></select><input type="text" placeholder="кабинет"></td>`;});
        html+=`</tr>`;
    }
    html+=`</tbody></table>`;
    card.innerHTML=html;
    document.getElementById('scheduleContainer').appendChild(card);

    ["Пн","Вт","Ср","Чт","Пт"].forEach((day,i)=>{
        scheduleData[cls][day].forEach((lesson,rowIndex)=>{
            const td=card.querySelectorAll('tbody tr')[rowIndex].children[i+1];
            const select=td.querySelector('select');
            const input=td.querySelector('input');
            subjects.forEach(s=>{const opt=document.createElement('option'); opt.value=s; opt.textContent=s||'—'; select.appendChild(opt);});
            select.value=lesson.subject;
            input.value=lesson.room;
            select.onchange=()=>{lesson.subject=select.value; saveSchedule();};
            input.oninput=()=>{lesson.room=input.value; saveSchedule();};
        });
    });
}
allClasses.forEach(createCard);

document.getElementById('loginBtn').onclick=async ()=>{
    const u=document.getElementById('loginUsername').value.trim();
    const p=document.getElementById('loginPassword').value.trim();
    if(!u||!p){alert('Введите данные'); return;}
    const { data:userData,error } = await supabase.from('users').select('*').eq('username',u).maybeSingle();
    if(error || !userData || userData.password!==p){alert('Неверные данные'); return;}
    currentUser = userData;
    document.getElementById('loginPopup').style.display='none';
    document.getElementById('scheduleWrapper').style.display='flex';
    document.getElementById('schoolName').style.display='block';
    document.getElementById('schoolName').textContent=currentUser.displayName;
    visibleClasses = allClasses.slice(); 
    showVisibleClasses();

    const { data:schData } = await supabase.from('schedule').select('*').eq('school_id',currentUser.id);
    if(schData){
        schData.forEach(row=>{
            if(scheduleData[row.class] && scheduleData[row.class][row.day] && scheduleData[row.class][row.day][row.row]){
                scheduleData[row.class][row.day][row.row].subject=row.subject;
                scheduleData[row.class][row.day][row.row].room=row.room;
                const card=document.querySelector(`.schedule-card[data-cls="${row.class}"]`);
                if(card){
                    const td=card.querySelectorAll('tbody tr')[row.row].children[["Пн","Вт","Ср","Чт","Пт"].indexOf(row.day)+1];
                    td.querySelector('select').value=row.subject;
                    td.querySelector('input').value=row.room;
                }
            }
        });
    }
}

async function saveSchedule(){
    if(!currentUser) return;
    for(const cls of allClasses){
        for(const day in scheduleData[cls]){
            for(let i=0;i<scheduleData[cls][day].length;i++){
                await supabase.from('schedule').upsert({
                    school_id: currentUser.id,
                    class: cls,
                    day: day,
                    row: i,
                    subject: scheduleData[cls][day][i].subject,
                    room: scheduleData[cls][day][i].room
                });
            }
        }
    }
}

let scrollInterval=null;
document.getElementById('autoScrollBtn').onclick=()=>{
    if(scrollInterval){clearInterval(scrollInterval); scrollInterval=null; return;}
    scrollInterval=setInterval(()=>{pageIndex=(pageIndex+1)%visibleClasses.length; updateScroll();},4000);
}
function updateScroll(){
    const container=document.getElementById('scheduleContainer');
    const cardWidth=container.querySelector('.schedule-card').offsetWidth + 16;
    container.style.transform=`translateX(-${pageIndex*cardWidth}px)`;
}

document.getElementById('selectClassesBtn').onclick=()=>{
    const sel=prompt(`Введите классы через запятую (например 1А,2Б,3В)\nВсе: оставить пустым`);
    if(sel===null) return;
    visibleClasses = sel?sel.split(',').map(s=>s.trim()).filter(s=>allClasses.includes(s)):allClasses.slice();
    showVisibleClasses();
    pageIndex=0; updateScroll();
}
function showVisibleClasses(){
    document.querySelectorAll('.schedule-card').forEach(c=>c.style.display='none');
    visibleClasses.forEach(cls=>{
        const card=document.querySelector(`.schedule-card[data-cls="${cls}"]`);
        if(card) card.style.display='flex';
    });
}

document.getElementById('fullscreenBtn').onclick=()=>{
    const container=document.getElementById('scheduleContainer');
    fullscreen=!fullscreen;
    container.style.flexWrap=fullscreen?'nowrap':'wrap';
}

document.getElementById('resetBtn').onclick=()=>{
    if(!currentUser) return;
    const cls = prompt("Какой класс очистить? (например 1А)");
    if(!cls || !scheduleData[cls]) return alert("Некорректный класс");
    ["Пн","Вт","Ср","Чт","Пт"].forEach(day=>{
        scheduleData[cls][day].forEach(lesson=>{lesson.subject=""; lesson.room="";});
    });
    const card=document.querySelector(`.schedule-card[data-cls="${cls}"]`);
    if(card){
        card.querySelectorAll('tbody tr').forEach(tr=>{
            Array.from(tr.children).slice(1).forEach(td=>{
                td.querySelector('select').value="";
                td.querySelector('input').value="";
            });
        });
    }
    saveSchedule();
}

setInterval(()=>{
    const d=new Date();
    document.getElementById('clock').textContent=d.toLocaleTimeString();
    document.getElementById('dateText').textContent=d.toLocaleDateString();
},1000);

document.getElementById('menuArrow').onclick=()=>{document.getElementById('menuItems').style.display=document.getElementById('menuItems').style.display==='block'?'none':'block';}

document.getElementById('createSchoolBtn').onclick=async ()=>{
    const name=prompt('Название школы:');
    if(!name) return;
    const { data,error } = await supabase.from('users').insert([{username:name,password:'1234',displayName:name,type:'school'}]);
    alert(error?`Ошибка: ${error.message}`:'Школа создана! Логин = имя школы, пароль = 1234');
};
document.getElementById('createAdminBtn').onclick=async ()=>{
    const name=prompt('Имя админа:');
    if(!name) return;
    const { data,error } = await supabase.from('users').insert([{username:name,password:'1234',displayName:name,type:'admin'}]);
    alert(error?`Ошибка: ${error.message}`:'Админ создан! Логин = имя, пароль = 1234');
};
</script>
</body>
</html>

